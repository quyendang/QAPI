<!DOCTYPE html>
<html>
<head>
    <title>Dashboard</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .status-online { color: green; }
        .status-offline { color: red; }
        .delete-btn { background-color: #ff4d4d; color: white; border: none; padding: 5px 10px; cursor: pointer; }
        .restart-btn { background-color: #4CAF50; color: white; border: none; padding: 5px 10px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Dashboard</h1>
    <div>
        <p>CPU: {{ cpu_percent }}%</p>
        <p>Memory: {{ memory_used }} GB / {{ memory_total }} GB ({{ memory_percent }}%)</p>
        <p>IPs: {{ total_ips }}</p>
        <form action="/delete-ips" method="post">
            <button type="submit" class="delete-btn">Delete</button>
        </form>
    </div>

    <h2>Devices List</h2>
    {% if devices %}
    <table>
        <tr>
            <th>No.</th>
            <th>Country</th>
            <th>IP</th>
            <th>Connect</th>
            <th>CPU (%)</th>
            <th>Thread</th>
            <th>RAM (/)</th>
            <th>Client</th>
            <th>Traffic</th>
            <th>R/TO</th>
            <th>Last Update</th>
            <th>Action</th>
        </tr>
        {% for device in devices %}
        {% set last_update_time = device.last_update|datetime_from_timestamp %}
        {% set is_old = last_update_time and (now|datetime_from_timestamp - last_update_time).total_seconds() > 900 %}
        {% set parts = device.id.split('-') %}
        <tr>
            <td>{{ loop.index }}</td>
            <td>{{ device.country_code or 'N/A' }}</td>
            <td>{{ device.ip or 'N/A' }}</td>
            <td>
                {% if device.ip is not none %}
                <span class="{% if is_old %}status-offline{% else %}status-online{% endif %}">
                    {% if is_old %}Offline{% else %}Online{% endif %}
                </span>
                {% else %}
                N/A
                {% endif %}
            </td>
            <td>
                {% if device.cpu_percent is not none %}
                {{ device.cpu_percent|round(2) }}%
                {% else %}
                N/A
                {% endif %}
            </td>
            <td>
                {% if device.currentThread is not none and device.totalThread is not none %}
                {{ device.currentThread }} / {{ device.totalThread }}
                {% else %}
                N/A
                {% endif %}
            </td>
            <td>
                {% if device.ram_used is not none and device.ram_total is not none %}
                {{ device.ram_used }} / {{ device.ram_total }}
                {% else %}
                N/A
                {% endif %}
            </td>
            <td>
                {{ parts[0]|upper or 'N/A' }}
                {% if not parts[1] %}N{% elif parts[1]|lower == 'a' %}A{% elif parts[1]|upper == 'PRO' %}P{% else %}{{parts[1]|upper}}{% endif %}
            </td>
            <td>
                {% if device.proxyTraffic is not none and device.bypassTraffic is not none %}
                {{ device.proxyTraffic|round(2) }} GB ({{ device.bypassTraffic|round(2) }} GB)
                {% else %}
                N/A
                {% endif %}
            </td>
            <td>
                {% if device.runtime %}
                {{ device.runtime|run_time }}
                {% else %}
                N/A
                {% endif %} / {{ device.counter5 or 'N/A' }}s
            </td>
            <td>
                {% if device.last_update %}
                {{ last_update_time|time_ago }}
                {% else %}
                N/A
                {% endif %}
            </td>
            <td>
                <form action="/device" method="post">
                    <input type="hidden" name="id" value="{{ device.id }}">
                    <input type="hidden" name="restart" value="true">
                    <button type="submit" class="restart-btn">Restart</button>
                </form>
                <form action="/device" method="delete">
                    <input type="hidden" name="id" value="{{ device.id }}">
                    <button type="submit" class="delete-btn">Delete</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </table>
    {% else %}
    <p>No devices found.</p>
    {% endif %}
</body>
</html>