<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.2/Babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lipis/flag-icons@7.3.2/css/flag-icons.min.css" />
</head>
<body>
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        const { useState, useEffect } = React;

        interface Device {
            id: string;
            country_code?: string;
            ip?: string;
            cpu_percent?: number;
            ram_used?: number;
            ram_total?: number;
            counter2?: string;
            counter5?: string;
            runtime?: number;
            last_update?: number;
        }

        const Dashboard = () => {
            const [devices, setDevices] = useState<Device[]>([]);
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState<string | null>(null);
            const [serverStats, setServerStats] = useState({
                cpu_percent: 0,
                memory_used: 0,
                memory_total: 0,
                memory_percent: 0,
                total_ips: 0
            });

            useEffect(() => {
                // Simulate fetching data
                fetch('/api/devices')
                    .then(res => res.json())
                    .then(data => {
                        setDevices(data.devices);
                        setServerStats(data.stats);
                        setIsLoading(false);
                    })
                    .catch(err => {
                        setError(err.message);
                        setIsLoading(false);
                    });
            }, []);

            const createRDPFile = (ip: string) => {
                const username = "administrator";
                const rdpContent = `
full address:s:${ip}:22
username:s:${username}
prompt for credentials:i:1
authentication level:i:2
screen mode id:i:2
desktopwidth:i:1920
desktopheight:i:1080
session bpp:i:32
                `.trim();
                const blob = new Blob([rdpContent], { type: "text/plain" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = `remote_${ip}.rdp`;
                link.click();
                URL.revokeObjectURL(url);
            };

            const handleDelete = async (id: string) => {
                try {
                    const response = await fetch(`/device?id=${encodeURIComponent(id)}`, {
                        method: 'DELETE'
                    });
                    const data = await response.json();
                    alert(data.message);
                    setDevices(devices.filter(device => device.id !== id));
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            };

            const handleRestart = async (id: string) => {
                try {
                    const response = await fetch('/device', {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id, restart: true })
                    });
                    const data = await response.json();
                    alert(data.message);
                    window.location.reload();
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            };

            const formatTimeAgo = (timestamp?: number) => {
                if (!timestamp) return 'N/A';
                const now = Date.now() / 1000;
                const diff = now - timestamp;
                if (diff < 60) return `${Math.round(diff)}s ago`;
                if (diff < 3600) return `${Math.round(diff / 60)}m ago`;
                return `${Math.round(diff / 3600)}h ago`;
            };

            const formatRuntime = (runtime?: number) => {
                if (!runtime) return 'N/A';
                const hours = Math.floor(runtime / 3600);
                const minutes = Math.floor((runtime % 3600) / 60);
                return `${hours}h ${minutes}m`;
            };

            if (isLoading) return <div className="flex justify-center items-center h-screen">Loading...</div>;
            if (error) return <div className="text-red-500 text-center">{error}</div>;

            return (
                <div className="container mx-auto p-4 max-w-7xl">
                    <h1 className="text-3xl font-bold text-center mb-6">Dashboard</h1>
                    
                    <div className="flex flex-wrap gap-4 mb-8 justify-center">
                        <div className="bg-yellow-100 text-yellow-800 px-4 py-2 rounded-lg">CPU: {serverStats.cpu_percent}%</div>
                        <div className="bg-blue-100 text-blue-800 px-4 py-2 rounded-lg">
                            Memory: {serverStats.memory_used} GB / {serverStats.memory_total} GB ({serverStats.memory_percent}%)
                        </div>
                        <div className="bg-gray-100 text-gray-800 px-4 py-2 rounded-lg">IPs: {serverStats.total_ips}</div>
                        <button 
                            onClick={() => fetch('/delete-ips', { method: 'POST' }).then(() => window.location.reload())}
                            className="bg-pink-500 text-white px-4 py-2 rounded-lg hover:bg-pink-600 transition-colors flex items-center gap-2"
                        >
                            Delete
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" className="bi bi-x-lg" viewBox="0 0 16 16">
                                <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z" />
                            </svg>
                        </button>
                    </div>

                    <div className="bg-white rounded-lg shadow-lg p-6">
                        <h2 className="text-xl font-semibold mb-4">Devices List</h2>
                        {devices.length === 0 ? (
                            <p className="text-gray-500 text-center">No devices found.</p>
                        ) : (
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm">
                                    <thead>
                                        <tr className="bg-gray-50 text-gray-600 uppercase text-xs">
                                            <th className="p-3">No.</th>
                                            <th className="p-3">Country</th>
                                            <th className="p-3">IP</th>
                                            <th className="p-3">Connect</th>
                                            <th className="p-3">CPU Usage</th>
                                            <th className="p-3">RAM</th>
                                            <th className="p-3">Client</th>
                                            <th className="p-3">NoAds/Time</th>
                                            <th className="p-3">Runtime</th>
                                            <th className="p-3">Last Update</th>
                                            <th className="p-3">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {devices.map((device, index) => {
                                            const lastUpdate = device.last_update ? new Date(device.last_update * 1000) : null;
                                            const isOld = lastUpdate && ((Date.now() / 1000) - device.last_update) > 900;
                                            const parts = device.id.split('-');
                                            const ramPercent = device.ram_total && device.ram_used ? (device.ram_used / device.ram_total * 100) : 0;

                                            return (
                                                <tr key={device.id} className={isOld ? 'bg-red-50' : 'hover:bg-gray-50'}>
                                                    <td className="p-3">{index + 1}</td>
                                                    <td className="p-3">
                                                        <span className={`fi fi-${device.country_code?.toLowerCase()} mr-2`}></span>
                                                        {device.country_code || 'N/A'}
                                                    </td>
                                                    <td className="p-3">{device.ip || 'N/A'}</td>
                                                    <td className="p-3">
                                                        {device.ip ? (
                                                            <button 
                                                                onClick={() => createRDPFile(device.ip!)}
                                                                className="bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600 transition-colors"
                                                            >
                                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" className="bi bi-arrow-right-short" viewBox="0 0 16 16">
                                                                    <path fillRule="evenodd" d="M4 8a.5.5 0 0 1 .5-.5h5.793L8.146 5.354a.5.5 0 1 1 .708-.708l3 3a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708-.708L10.293 8.5H4.5A.5.5 0 0 1 4 8" />
                                                                </svg>
                                                            </button>
                                                        ) : 'N/A'}
                                                    </td>
                                                    <td className="p-3">
                                                        {device.cpu_percent != null ? (
                                                            <>
                                                                <p>{device.cpu_percent.toFixed(1)}%</p>
                                                                <div className="w-24 bg-gray-200 rounded-full h-2.5">
                                                                    <div 
                                                                        className={`h-2.5 rounded-full ${device.cpu_percent > 50 ? 'bg-pink-500' : 'bg-green-500'}`} 
                                                                        style={{ width: `${device.cpu_percent}%` }}
                                                                    ></div>
                                                                </div>
                                                            </>
                                                        ) : 'N/A'}
                                                    </td>
                                                    <td className="p-3">
                                                        {device.ram_used != null && device.ram_total != null ? (
                                                            <>
                                                                <p>{device.ram_used}MB/{device.ram_total}MB</p>
                                                                <div className="w-24 bg-gray-200 rounded-full h-2.5">
                                                                    <div 
                                                                        className={`h-2.5 rounded-full ${ramPercent > 50 ? 'bg-pink-500' : 'bg-green-500'}`} 
                                                                        style={{ width: `${ramPercent}%` }}
                                                                    ></div>
                                                                </div>
                                                            </>
                                                        ) : 'N/A'}
                                                    </td>
                                                    <td className="p-3">
                                                        <span className={`inline-block px-2 py-1 rounded text-white ${
                                                            !parts[1] ? 'bg-gray-500' : 
                                                            parts[1].toLowerCase() === 'a' ? 'bg-yellow-500' :
                                                            parts[1].toUpperCase() === 'PRO' ? 'bg-pink-500' : 'bg-teal-500'
                                                        }`}>
                                                            {!parts[1] ? 'Normal' : 
                                                             parts[1].toLowerCase() === 'a' ? 'Asia' :
                                                             parts[1].toUpperCase() === 'PRO' ? 'Pro' : parts[1].charAt(0).toUpperCase() + parts[1].slice(1)}
                                                        </span>
                                                        <span className="ml-2">{parts[0].toUpperCase() || 'N/A'}</span>
                                                    </td>
                                                    <td className="p-3">{device.counter2 || 'N/A'}-{device.counter5 || 'N/A'}s</td>
                                                    <td className="p-3">{formatRuntime(device.runtime)}</td>
                                                    <td className="p-3">{formatTimeAgo(device.last_update)}</td>
                                                    <td className="p-3">
                                                        <div className="flex gap-2">
                                                            <button 
                                                                onClick={() => handleDelete(device.id)}
                                                                className="bg-pink-500 text-white px-2 py-1 rounded hover:bg-pink-600 transition-colors flex items-center gap-1"
                                                            >
                                                                Delete
                                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" className="bi bi-x-lg" viewBox="0 0 16 16">
                                                                    <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z" />
                                                                </svg>
                                                            </button>
                                                            <button 
                                                                onClick={() => handleRestart(device.id)}
                                                                className="bg-yellow-500 text-white px-2 py-1 rounded hover:bg-yellow-600 transition-colors flex items-center gap-1"
                                                            >
                                                                Restart
                                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" className="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                                                                    <path fillRule="evenodd" d="M8 3a5 5 0 1 1-4.546 2

.914.5.5 0 0 1 .908-.417A4 4 0 1 0 8 4v1.5a.5.5 0 0 1-1 0V3a.5.5 0 0 1 .5-.5H11a.5.5 0 0 1 0 1H8.707A5.001 5.001 0 0 1 8 3z" />
                                                                </svg>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<Dashboard />, document.getElementById('root'));
    </script>
</body>
</html>
